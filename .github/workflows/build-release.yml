name: Build DRAW

on:
  push:
    # branches: [ main ]
    tags: [ 'v*' ]
  # pull_request:
    #  branches: [ main ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release after building'
        type: boolean
        default: false
      tag:
        description: 'Tag name for release (e.g. v0.7.5)'
        type: string
        default: ''

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Build for Linux
        uses: grymmjack/qb64pe-docker@main
        with:
          platform: 'linux'
          source-file: 'DRAW.BAS'
          project-name: 'DRAW'
          qb64pe-version: 'v4.4.0'
          remove-empty-dirs: 'true' 
  
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Build for Windows
        uses: grymmjack/qb64pe-docker@main
        with:
          platform: 'windows'
          source-file: 'DRAW.BAS'
          project-name: 'DRAW'
          qb64pe-version: 'v4.4.0'
          remove-empty-dirs: 'true' 
  
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Build for macOS
        uses: grymmjack/qb64pe-docker@main
        with:
          platform: 'macos'
          source-file: 'DRAW.BAS'
          project-name: 'DRAW'
          qb64pe-version: 'v4.4.0'
          remove-empty-dirs: 'true'
      
      - name: Create macOS .app bundle
        run: |
          # Find the compiled executable
          EXECUTABLE=$(find . -name "DRAW" -type f -perm +111 ! -path "*.app*" ! -path "*qb64pe*" | head -1)
          if [ -z "$EXECUTABLE" ]; then
            echo "Warning: Could not find DRAW executable, skipping .app bundle"
            exit 0
          fi
          
          # Create AppleScript applet for proper macOS file association handling
          # AppleScript applets natively handle Apple Events (kAEOpenDocuments),
          # which is how Finder sends file-open requests when double-clicking .draw files.
          ASCRIPT_SRC=$(mktemp /tmp/DRAW_launcher.XXXXXX.applescript)
          cat > "$ASCRIPT_SRC" << 'APPLESCRIPT'
          on run
              set myDir to POSIX path of (path to me)
              set resDir to myDir & "Contents/Resources/"
              set binPath to myDir & "Contents/MacOS/DRAW.bin"
              do shell script "cd " & quoted form of resDir & " && " & quoted form of binPath & " > /dev/null 2>&1 &"
          end run

          on open theFiles
              set filePath to POSIX path of (item 1 of theFiles)
              set myDir to POSIX path of (path to me)
              set resDir to myDir & "Contents/Resources/"
              set binPath to myDir & "Contents/MacOS/DRAW.bin"
              do shell script "cd " & quoted form of resDir & " && DRAW_OPEN_FILE=" & quoted form of filePath & " " & quoted form of binPath & " > /dev/null 2>&1 &"
          end open
          APPLESCRIPT
          
          osacompile -o DRAW.app "$ASCRIPT_SRC"
          rm -f "$ASCRIPT_SRC"
          
          # Copy QB64-PE executable into the applet bundle
          cp "$EXECUTABLE" DRAW.app/Contents/MacOS/DRAW.bin
          chmod +x DRAW.app/Contents/MacOS/DRAW.bin
          
          # Copy icon (replace default applet icon)
          cp ASSETS/ICONS/icon.icns DRAW.app/Contents/Resources/icon.icns
          cp ASSETS/ICONS/icon.icns DRAW.app/Contents/Resources/applet.icns
          
          # Copy ASSETS directory (needed at runtime for fonts, palettes, etc.)
          cp -r ASSETS DRAW.app/Contents/Resources/ASSETS
          
          # Copy default configuration
          cp DRAW.cfg DRAW.app/Contents/Resources/DRAW.cfg
          
          # Replace Info.plist with our custom one (document types + UTI declarations)
          cp ASSETS/ICONS/Info.plist DRAW.app/Contents/Info.plist
          
          echo "Created DRAW.app bundle successfully"
          ls -la DRAW.app/Contents/
          ls -la DRAW.app/Contents/MacOS/
          ls -la DRAW.app/Contents/Resources/
      
      - name: Upload macOS app bundle
        uses: actions/upload-artifact@v4
        with:
          name: DRAW-osx-app-bundle
          path: DRAW.app
  
  release:
    name: Create Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || inputs.create_release == true
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List artifact contents (debug)
        run: find artifacts -type f | head -50
      
      - name: Package release archives
        run: |
          mkdir -p release
          
          # Linux: find the tar.gz produced by qb64pe-docker
          LINUX_ARCHIVE=$(find artifacts/DRAW-linux -name "*.tar.gz" -type f 2>/dev/null | head -1)
          if [ -n "$LINUX_ARCHIVE" ]; then
            cp "$LINUX_ARCHIVE" release/DRAW-lnx-x64.tar.gz
          else
            # Fallback: package the artifact directory contents
            (cd artifacts/DRAW-linux && tar czf ../../release/DRAW-lnx-x64.tar.gz *)
          fi
          
          # Windows: find the zip produced by qb64pe-docker
          WIN_ARCHIVE=$(find artifacts/DRAW-windows -name "*.zip" -type f 2>/dev/null | head -1)
          if [ -n "$WIN_ARCHIVE" ]; then
            cp "$WIN_ARCHIVE" release/DRAW-win-x64.zip
          else
            (cd artifacts/DRAW-windows && zip -r ../../release/DRAW-win-x64.zip *)
          fi
          
          # macOS: package the regular build (flat archive)
          MACOS_ARCHIVE=$(find artifacts/DRAW-macos -name "*.tar.gz" -type f 2>/dev/null | head -1)
          if [ -n "$MACOS_ARCHIVE" ]; then
            cp "$MACOS_ARCHIVE" release/DRAW-osx-x64.tar.gz
          else
            (cd artifacts/DRAW-macos && tar czf ../../release/DRAW-osx-x64.tar.gz *)
          fi
          
          # macOS .app bundle: upload-artifact flattens the .app directory
          # so Contents/ ends up directly in the artifact root â€” reconstruct it
          if [ -d "artifacts/DRAW-osx-app-bundle" ]; then
            if [ -d "artifacts/DRAW-osx-app-bundle/Contents" ] && [ ! -d "artifacts/DRAW-osx-app-bundle/DRAW.app" ]; then
              mkdir -p artifacts/DRAW-osx-app-bundle/DRAW.app
              mv artifacts/DRAW-osx-app-bundle/Contents artifacts/DRAW-osx-app-bundle/DRAW.app/
            fi
            (cd artifacts/DRAW-osx-app-bundle && tar czf ../../release/DRAW-osx-app-bundle.tar.gz DRAW.app)
          fi
          
          echo "Release archives:"
          ls -lh release/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          draft: false
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}