name: Build DRAW

on:
  push:
    # branches: [ main ]
    tags: [ 'v*' ]
  # pull_request:
    #  branches: [ main ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release after building'
        type: boolean
        default: false
      tag:
        description: 'Tag name for release (e.g. v0.7.4)'
        type: string
        default: ''

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Build for Linux
        uses: grymmjack/qb64pe-docker@main
        with:
          platform: 'linux'
          source-file: 'DRAW.BAS'
          project-name: 'DRAW'
          qb64pe-version: 'v4.3.0'
          remove-empty-dirs: 'true' 
  
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Build for Windows
        uses: grymmjack/qb64pe-docker@main
        with:
          platform: 'windows'
          source-file: 'DRAW.BAS'
          project-name: 'DRAW'
          qb64pe-version: 'v4.3.0'
          remove-empty-dirs: 'true' 
  
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Build for macOS
        uses: grymmjack/qb64pe-docker@main
        with:
          platform: 'macos'
          source-file: 'DRAW.BAS'
          project-name: 'DRAW'
          qb64pe-version: 'v4.3.0'
          remove-empty-dirs: 'true'
      
      - name: Create macOS .app bundle
        run: |
          # Find the compiled executable
          EXECUTABLE=$(find . -name "DRAW" -type f -perm +111 ! -path "*.app*" ! -path "*qb64pe*" | head -1)
          if [ -z "$EXECUTABLE" ]; then
            echo "Warning: Could not find DRAW executable, skipping .app bundle"
            exit 0
          fi
          
          # Create .app bundle structure
          mkdir -p DRAW.app/Contents/MacOS
          mkdir -p DRAW.app/Contents/Resources
          
          # Copy executable
          cp "$EXECUTABLE" DRAW.app/Contents/MacOS/DRAW
          chmod +x DRAW.app/Contents/MacOS/DRAW
          
          # Copy Info.plist
          cp ASSETS/ICONS/Info.plist DRAW.app/Contents/Info.plist
          
          # Copy icon
          cp ASSETS/ICONS/icon.icns DRAW.app/Contents/Resources/icon.icns
          
          # Copy ASSETS directory (needed at runtime for icon, fonts, palettes, etc.)
          cp -r ASSETS DRAW.app/Contents/MacOS/ASSETS
          
          echo "Created DRAW.app bundle successfully"
          ls -la DRAW.app/Contents/
          ls -la DRAW.app/Contents/MacOS/
          ls -la DRAW.app/Contents/Resources/
      
      - name: Upload macOS app bundle
        uses: actions/upload-artifact@v4
        with:
          name: DRAW-osx-app-bundle
          path: DRAW.app
  
  release:
    name: Create Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || inputs.create_release == true
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List artifact contents (debug)
        run: find artifacts -type f | head -50
      
      - name: Package release archives
        run: |
          mkdir -p release
          
          # Linux: find the tar.gz produced by qb64pe-docker
          LINUX_ARCHIVE=$(find artifacts/DRAW-linux -name "*.tar.gz" -type f 2>/dev/null | head -1)
          if [ -n "$LINUX_ARCHIVE" ]; then
            cp "$LINUX_ARCHIVE" release/DRAW-lnx-x64.tar.gz
          else
            # Fallback: package the artifact directory contents
            cd artifacts/DRAW-linux && tar czf ../../release/DRAW-lnx-x64.tar.gz * && cd ../..
          fi
          
          # Windows: find the zip produced by qb64pe-docker
          WIN_ARCHIVE=$(find artifacts/DRAW-windows -name "*.zip" -type f 2>/dev/null | head -1)
          if [ -n "$WIN_ARCHIVE" ]; then
            cp "$WIN_ARCHIVE" release/DRAW-win-x64.zip
          else
            cd artifacts/DRAW-windows && zip -r ../../release/DRAW-win-x64.zip * && cd ../..
          fi
          
          # macOS: package the regular build (flat archive)
          MACOS_ARCHIVE=$(find artifacts/DRAW-macos -name "*.tar.gz" -type f 2>/dev/null | head -1)
          if [ -n "$MACOS_ARCHIVE" ]; then
            cp "$MACOS_ARCHIVE" release/DRAW-osx-x64.tar.gz
          else
            cd artifacts/DRAW-macos && tar czf ../../release/DRAW-osx-x64.tar.gz * && cd ../..
          fi
          
          # macOS .app bundle: package as tar.gz preserving structure
          if [ -d "artifacts/DRAW-osx-app-bundle" ]; then
            cd artifacts/DRAW-osx-app-bundle && tar czf ../../release/DRAW-osx-app-bundle.tar.gz DRAW.app && cd ../..
          fi
          
          echo "Release archives:"
          ls -lh release/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          draft: false
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}