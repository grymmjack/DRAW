''
' DRAW - GUI/CURSOR.BM
' =============================================================================
' Cursor system implementation.
'
' Loads cursor PNGs from the theme directory, evaluates position expressions,
' and renders optional overlays (FG/BG color chips, text).
'
' @author Rick Christy <grymmjack@gmail.com>
'
$INCLUDEONCE


''
' Initialize the cursor system.
' Clears all cursor state. Call CURSOR_load_all after CONFIG_load to set
' the directory from CFG.THEME$ and pre-load all cursor images.
'
SUB CURSOR_init ()
    DIM i AS INTEGER
    CURSORS_DIR$ = ""
    FOR i% = 0 TO CURSOR_COUNT
        CURSORS(i%).loaded% = FALSE
        CURSORS(i%).img& = 0
        CURSORS(i%).w% = 0
        CURSORS(i%).h% = 0
        CURSORS(i%).hotspot_pos_x% = 0
        CURSORS(i%).hotspot_pos_y% = 0
    NEXT i%
END SUB


''
' Pre-load ALL cursor images using the theme from CFG.THEME$.
' Call once after CONFIG_load so CFG.THEME$ is set correctly.
'
SUB CURSOR_load_all ()
    DIM i AS INTEGER
    ' Build cursor directory from configured theme
    CURSORS_DIR$ = "ASSETS/THEMES/" + CFG.THEME$ + "/CURSORS/"
    ' Reset loaded flags so cursors reload with the correct path
    FOR i% = 0 TO CURSOR_COUNT
        IF CURSORS(i%).img& < -1 THEN _FREEIMAGE CURSORS(i%).img&
        CURSORS(i%).img& = 0
        CURSORS(i%).loaded% = FALSE
    NEXT i%
    ' Pre-load every cursor that has a filename configured
    FOR i% = 0 TO CURSOR_COUNT
        IF LEN(CURSORS(i%).filename$) > 0 THEN
            CURSOR_load i%
        END IF
    NEXT i%
END SUB


''
' Load a cursor PNG by index. Only loads once per cursor.
' Evaluates all position expressions after loading the image dimensions.
'
' @param idx% Cursor index (CURSOR_NULL, CURSOR_BRUSH, etc.)
'
SUB CURSOR_load (idx AS INTEGER)
    IF idx% < 0 OR idx% > CURSOR_COUNT THEN EXIT SUB
    IF CURSORS(idx%).loaded% THEN EXIT SUB

    CURSORS(idx%).loaded% = TRUE

    ' Skip if no filename configured
    IF LEN(CURSORS(idx%).filename$) = 0 THEN EXIT SUB

    ' Build full path and load
    DIM full_path AS STRING
    full_path$ = CURSORS_DIR$ + CURSORS(idx%).filename$

    IF NOT _FILEEXISTS(full_path$) THEN
        EXIT SUB
    END IF

    DIM handle AS LONG
    handle& = _LOADIMAGE(full_path$, 32)

    IF handle& >= -1 THEN
        ' Load failed
        EXIT SUB
    END IF

    ' Store handle and cache dimensions
    CURSORS(idx%).img& = handle&
    CURSORS(idx%).w% = _WIDTH(handle&)
    CURSORS(idx%).h% = _HEIGHT(handle&)

    ' Evaluate hotspot expressions
    IF LEN(CURSORS(idx%).hotspot_x_expr$) > 0 THEN
        CURSORS(idx%).hotspot_pos_x% = CURSOR_eval_expr%(CURSORS(idx%).hotspot_x_expr$, CURSORS(idx%).w%, TRUE)
    END IF
    IF LEN(CURSORS(idx%).hotspot_y_expr$) > 0 THEN
        CURSORS(idx%).hotspot_pos_y% = CURSOR_eval_expr%(CURSORS(idx%).hotspot_y_expr$, CURSORS(idx%).h%, FALSE)
    END IF

    ' Evaluate FG color overlay expressions
    IF CURSORS(idx%).uses_overlay_fg% THEN
        IF LEN(CURSORS(idx%).fg_color_x$) > 0 THEN
            CURSORS(idx%).fg_color_px% = CURSOR_eval_expr%(CURSORS(idx%).fg_color_x$, CURSORS(idx%).w%, TRUE)
        END IF
        IF LEN(CURSORS(idx%).fg_color_y$) > 0 THEN
            CURSORS(idx%).fg_color_py% = CURSOR_eval_expr%(CURSORS(idx%).fg_color_y$, CURSORS(idx%).h%, FALSE)
        END IF
        IF LEN(CURSORS(idx%).fg_color_w$) > 0 THEN
            CURSORS(idx%).fg_color_pw% = CURSOR_eval_expr%(CURSORS(idx%).fg_color_w$, CURSORS(idx%).w%, TRUE)
        END IF
        IF LEN(CURSORS(idx%).fg_color_h$) > 0 THEN
            CURSORS(idx%).fg_color_ph% = CURSOR_eval_expr%(CURSORS(idx%).fg_color_h$, CURSORS(idx%).h%, FALSE)
        END IF
    END IF

    ' Evaluate BG color overlay expressions
    IF CURSORS(idx%).uses_overlay_bg% THEN
        IF LEN(CURSORS(idx%).bg_color_x$) > 0 THEN
            CURSORS(idx%).bg_color_px% = CURSOR_eval_expr%(CURSORS(idx%).bg_color_x$, CURSORS(idx%).w%, TRUE)
        END IF
        IF LEN(CURSORS(idx%).bg_color_y$) > 0 THEN
            CURSORS(idx%).bg_color_py% = CURSOR_eval_expr%(CURSORS(idx%).bg_color_y$, CURSORS(idx%).h%, FALSE)
        END IF
        IF LEN(CURSORS(idx%).bg_color_w$) > 0 THEN
            CURSORS(idx%).bg_color_pw% = CURSOR_eval_expr%(CURSORS(idx%).bg_color_w$, CURSORS(idx%).w%, TRUE)
        END IF
        IF LEN(CURSORS(idx%).bg_color_h$) > 0 THEN
            CURSORS(idx%).bg_color_ph% = CURSOR_eval_expr%(CURSORS(idx%).bg_color_h$, CURSORS(idx%).h%, FALSE)
        END IF
    END IF

    ' Evaluate coords overlay expressions
    IF CURSORS(idx%).uses_overlay_coords% THEN
        IF LEN(CURSORS(idx%).overlay_coords_x$) > 0 THEN
            CURSORS(idx%).overlay_coords_px% = CURSOR_eval_expr%(CURSORS(idx%).overlay_coords_x$, CURSORS(idx%).w%, TRUE)
        END IF
        IF LEN(CURSORS(idx%).overlay_coords_y$) > 0 THEN
            CURSORS(idx%).overlay_coords_py% = CURSOR_eval_expr%(CURSORS(idx%).overlay_coords_y$, CURSORS(idx%).h%, FALSE)
        END IF
    END IF

    ' Evaluate transform overlay expressions
    IF CURSORS(idx%).uses_overlay_transform% THEN
        IF LEN(CURSORS(idx%).overlay_transform_x$) > 0 THEN
            CURSORS(idx%).overlay_transform_px% = CURSOR_eval_expr%(CURSORS(idx%).overlay_transform_x$, CURSORS(idx%).w%, TRUE)
        END IF
        IF LEN(CURSORS(idx%).overlay_transform_y$) > 0 THEN
            CURSORS(idx%).overlay_transform_py% = CURSOR_eval_expr%(CURSORS(idx%).overlay_transform_y$, CURSORS(idx%).h%, FALSE)
        END IF
    END IF
END SUB


''
' Evaluate a position expression string into a pixel coordinate.
'
' Supports keywords:
'   left, top       -> 0
'   right           -> dimension - 1  (when is_x_axis)
'   bottom, bot     -> dimension - 1  (when not is_x_axis)
'   center          -> dimension \ 2
'
' Supports arithmetic: keyword+N, keyword-N, N (literal number)
' Also supports expressions going outside the image: left-20, right+20, top-10, etc.
'
' @param expr$      The expression string to evaluate
' @param dimension% The relevant dimension (width for X, height for Y)
' @param is_x_axis% TRUE if evaluating X axis (determines right/left), FALSE for Y (top/bottom)
' @return The evaluated pixel position
'
FUNCTION CURSOR_eval_expr% (expr AS STRING, dimension AS INTEGER, is_x_axis AS INTEGER)
    DIM e AS STRING
    DIM base_val AS INTEGER
    DIM op_pos AS INTEGER
    DIM op_char AS STRING
    DIM offset_str AS STRING
    DIM offset_val AS INTEGER
    DIM keyword AS STRING

    e$ = LTRIM$(RTRIM$(LCASE$(expr$)))

    ' Check for empty expression
    IF LEN(e$) = 0 THEN
        CURSOR_eval_expr% = 0
        EXIT FUNCTION
    END IF

    ' Try pure numeric first
    IF e$ = "0" OR VAL(e$) <> 0 OR (LEFT$(e$, 1) = "-" AND LEN(e$) > 1) THEN
        ' Check if it's truly numeric (no alpha chars)
        DIM is_numeric AS INTEGER
        DIM c AS INTEGER
        is_numeric% = TRUE
        FOR c% = 1 TO LEN(e$)
            DIM ch AS STRING
            ch$ = MID$(e$, c%, 1)
            IF ch$ <> "-" AND ch$ <> "+" AND (ch$ < "0" OR ch$ > "9") THEN
                is_numeric% = FALSE
                EXIT FOR
            END IF
        NEXT c%
        IF is_numeric% THEN
            CURSOR_eval_expr% = VAL(e$)
            EXIT FUNCTION
        END IF
    END IF

    ' Find arithmetic operator (+ or -) after keyword
    ' Scan from right to left for + or - that is not at position 1
    op_pos% = 0
    op_char$ = ""
    DIM scan_pos AS INTEGER
    FOR scan_pos% = LEN(e$) TO 2 STEP -1
        DIM sc AS STRING
        sc$ = MID$(e$, scan_pos%, 1)
        IF sc$ = "+" OR sc$ = "-" THEN
            ' Make sure chars before this are alpha (keyword part)
            DIM before_char AS STRING
            before_char$ = MID$(e$, scan_pos% - 1, 1)
            IF (before_char$ >= "a" AND before_char$ <= "z") OR (before_char$ >= "A" AND before_char$ <= "Z") THEN
                op_pos% = scan_pos%
                op_char$ = sc$
                EXIT FOR
            END IF
        END IF
    NEXT scan_pos%

    ' Extract keyword and offset
    IF op_pos% > 0 THEN
        keyword$ = LTRIM$(RTRIM$(LEFT$(e$, op_pos% - 1)))
        offset_str$ = LTRIM$(RTRIM$(MID$(e$, op_pos% + 1)))
        offset_val% = VAL(offset_str$)
        IF op_char$ = "-" THEN offset_val% = -offset_val%
    ELSE
        keyword$ = e$
        offset_val% = 0
    END IF

    ' Evaluate keyword
    SELECT CASE keyword$
        CASE "left"
            base_val% = 0
        CASE "top"
            base_val% = 0
        CASE "right"
            base_val% = dimension% - 1
        CASE "bottom", "bot"
            base_val% = dimension% - 1
        CASE "center"
            base_val% = (dimension% - 1) \ 2
        CASE ELSE
            ' Unknown keyword, try as number
            base_val% = VAL(keyword$)
    END SELECT

    CURSOR_eval_expr% = base_val% + offset_val%
END FUNCTION


''
' Render overlays (FG/BG color chips, text) on top of a cursor.
' Call this immediately after _PUTIMAGE of the cursor PNG.
'
' All overlay positions are relative to the draw position (dx%, dy%)
' which is the top-left corner where the cursor image was placed.
'
' @param idx%     Cursor index
' @param dx%      Draw X position (cursor image top-left)
' @param dy%      Draw Y position (cursor image top-left)
' @param mouse_x% Current mouse X on canvas
' @param mouse_y% Current mouse Y on canvas
' @param ow%      Old width (for transform template)
' @param oh%      Old height (for transform template)
' @param ox%      Old X position (for transform template)
' @param oy%      Old Y position (for transform template)
' @param nw%      New width (for transform template)
' @param nh%      New height (for transform template)
' @param nx%      New X position (for transform template)
' @param ny%      New Y position (for transform template)
'
SUB CURSOR_render_overlays (idx AS INTEGER, dx AS INTEGER, dy AS INTEGER, mouse_x AS INTEGER, mouse_y AS INTEGER, ow AS INTEGER, oh AS INTEGER, ox AS INTEGER, oy AS INTEGER, nw AS INTEGER, nh AS INTEGER, nx AS INTEGER, ny AS INTEGER)
    IF idx% < 0 OR idx% > CURSOR_COUNT THEN EXIT SUB

    ' Render FG color chip
    IF CURSORS(idx%).uses_overlay_fg% THEN
        IF CURSORS(idx%).fg_color_pw% > 0 AND CURSORS(idx%).fg_color_ph% > 0 THEN
            DIM fg_x1 AS INTEGER, fg_y1 AS INTEGER
            DIM fg_x2 AS INTEGER, fg_y2 AS INTEGER
            fg_x1% = dx% + CURSORS(idx%).fg_color_px%
            fg_y1% = dy% + CURSORS(idx%).fg_color_py%
            fg_x2% = fg_x1% + CURSORS(idx%).fg_color_pw% - 1
            fg_y2% = fg_y1% + CURSORS(idx%).fg_color_ph% - 1
            LINE (fg_x1%, fg_y1%)-(fg_x2%, fg_y2%), PAINT_COLOR~&, BF
        END IF
    END IF

    ' Render BG color chip
    IF CURSORS(idx%).uses_overlay_bg% THEN
        IF CURSORS(idx%).bg_color_pw% > 0 AND CURSORS(idx%).bg_color_ph% > 0 THEN
            DIM bg_x1 AS INTEGER, bg_y1 AS INTEGER
            DIM bg_x2 AS INTEGER, bg_y2 AS INTEGER
            bg_x1% = dx% + CURSORS(idx%).bg_color_px%
            bg_y1% = dy% + CURSORS(idx%).bg_color_py%
            bg_x2% = bg_x1% + CURSORS(idx%).bg_color_pw% - 1
            bg_y2% = bg_y1% + CURSORS(idx%).bg_color_ph% - 1
            LINE (bg_x1%, bg_y1%)-(bg_x2%, bg_y2%), PAINT_BG_COLOR~&, BF
        END IF
    END IF

    ' Render coords text overlay
    IF CURSORS(idx%).uses_overlay_coords% THEN
        IF LEN(CURSORS(idx%).overlay_coords_text$) > 0 THEN
            DIM coords_text AS STRING
            coords_text$ = CURSOR_format_text$(CURSORS(idx%).overlay_coords_text$, mouse_x%, mouse_y%, ow%, oh%, ox%, oy%, nw%, nh%, nx%, ny%)
            DIM ct_x AS INTEGER, ct_y AS INTEGER
            ct_x% = dx% + CURSORS(idx%).overlay_coords_px%
            ct_y% = dy% + CURSORS(idx%).overlay_coords_py%
            ' Draw text with black shadow for readability
            _PRINTSTRING (ct_x% + 1, ct_y% + 1), coords_text$
            COLOR _RGB32(255, 255, 255)
            _PRINTSTRING (ct_x%, ct_y%), coords_text$
        END IF
    END IF

    ' Render transform text overlay
    IF CURSORS(idx%).uses_overlay_transform% THEN
        IF LEN(CURSORS(idx%).overlay_transform_text$) > 0 THEN
            DIM transform_text AS STRING
            transform_text$ = CURSOR_format_text$(CURSORS(idx%).overlay_transform_text$, mouse_x%, mouse_y%, ow%, oh%, ox%, oy%, nw%, nh%, nx%, ny%)
            DIM tt_x AS INTEGER, tt_y AS INTEGER
            tt_x% = dx% + CURSORS(idx%).overlay_transform_px%
            tt_y% = dy% + CURSORS(idx%).overlay_transform_py%
            ' Draw text with black shadow for readability
            _PRINTSTRING (tt_x% + 1, tt_y% + 1), transform_text$
            COLOR _RGB32(255, 255, 255)
            _PRINTSTRING (tt_x%, tt_y%), transform_text$
        END IF
    END IF
END SUB


''
' Format a text template by replacing variables with runtime values.
'
' Template variables:
'   %mx %my   = mouse position x/y
'   %ow %oh   = old width/height
'   %ox %oy   = old x/y position
'   %nw %nh   = new width/height
'   %nx %ny   = new x/y position
'
' @param template$  The template string with %xx variables
' @param mouse_x%   Mouse X position
' @param mouse_y%   Mouse Y position
' @param ow%        Old width
' @param oh%        Old height
' @param ox%        Old X
' @param oy%        Old Y
' @param nw%        New width
' @param nh%        New height
' @param nx%        New X
' @param ny%        New Y
' @return Formatted string with all variables replaced
'
FUNCTION CURSOR_format_text$ (template AS STRING, mouse_x AS INTEGER, mouse_y AS INTEGER, ow AS INTEGER, oh AS INTEGER, ox AS INTEGER, oy AS INTEGER, nw AS INTEGER, nh AS INTEGER, nx AS INTEGER, ny AS INTEGER)
    DIM result AS STRING
    result$ = template$

    ' Replace all template variables (longest first to avoid partial matches)
    ' Mouse position
    DIM find_pos AS INTEGER
    find_pos% = INSTR(result$, "%mx")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(mouse_x%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%mx")
    WEND

    find_pos% = INSTR(result$, "%my")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(mouse_y%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%my")
    WEND

    ' Old dimensions
    find_pos% = INSTR(result$, "%ow")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(ow%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%ow")
    WEND

    find_pos% = INSTR(result$, "%oh")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(oh%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%oh")
    WEND

    find_pos% = INSTR(result$, "%ox")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(ox%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%ox")
    WEND

    find_pos% = INSTR(result$, "%oy")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(oy%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%oy")
    WEND

    ' New dimensions
    find_pos% = INSTR(result$, "%nw")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(nw%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%nw")
    WEND

    find_pos% = INSTR(result$, "%nh")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(nh%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%nh")
    WEND

    find_pos% = INSTR(result$, "%nx")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(nx%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%nx")
    WEND

    find_pos% = INSTR(result$, "%ny")
    WHILE find_pos% > 0
        result$ = LEFT$(result$, find_pos% - 1) + LTRIM$(STR$(ny%)) + MID$(result$, find_pos% + 3)
        find_pos% = INSTR(result$, "%ny")
    WEND

    CURSOR_format_text$ = result$
END FUNCTION


''
' Free all loaded cursor image handles.
' Call on shutdown or theme change.
'
SUB CURSOR_cleanup ()
    DIM i AS INTEGER
    FOR i% = 0 TO CURSOR_COUNT
        IF CURSORS(i%).img& < -1 THEN
            _FREEIMAGE CURSORS(i%).img&
        END IF
        CURSORS(i%).img& = 0
        CURSORS(i%).loaded% = FALSE
        CURSORS(i%).w% = 0
        CURSORS(i%).h% = 0
    NEXT i%
END SUB
